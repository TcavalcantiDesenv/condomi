<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!-- CSP de backup: só funciona se o servidor NÃO enviar outro cabeçalho CSP -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co wss://*.supabase.in https://esm.sh http://127.0.0.1:* ws://127.0.0.1:* http://localhost:* ws://localhost:*; script-src 'self' 'unsafe-inline' https://esm.sh; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: blob:; font-src 'self' data: https://fonts.gstatic.com; frame-src 'self'; base-uri 'self'; form-action 'self'; worker-src 'self' blob:; object-src 'none'">

<title>Condo • Administração</title>
<link rel="icon" href="/favicon.svg"/>

<style>
  :root{
    --brand-start:#6C2BD9; --brand-end:#8B5CF6; --on-brand:#fff;
    --bg:#0B0F16; --surface:#0F1420; --surface-2:#12182A; --text:#E8ECF4; --muted:#A3ADC2;
    --border:#223049; --radius:14px; --gap:12px;
    --ok:#22C55E; --warn:#F59E0B; --danger:#EF4444;
  }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(160deg,#0b0f16,#0d1020);color:var(--text)}
  .layout{display:grid; grid-template-columns: 280px 1fr; min-height:100vh}
  @media (max-width: 980px){ .layout{ grid-template-columns: 1fr } }
  header.appbar{
    position:sticky; top:0; z-index:3;
    background:linear-gradient(90deg,var(--brand-start),var(--brand-end)); color:var(--on-brand);
    display:flex; align-items:center; justify-content:space-between; padding:10px 14px; gap:10px;
  }
  header .left{display:flex; align-items:center; gap:10px}
  .logo{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#fff1;color:#fff;border:1px solid #ffffff33}
  .brand{font-weight:800}
  .actions{display:flex; gap:8px}
  .btn{border:none; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700}
  .btn.ghost{background:transparent; color:#fff; border:1px solid #ffffff33}
  .btn.install{background:#ffffff22; color:#fff}
  main#view{ padding:14px; }
  .guard-msg{ padding:18px; border:1px dashed var(--border); border-radius:12px; color:var(--muted); background:linear-gradient(180deg,#ffffff08,#ffffff04) }
</style>
</head>
<body>

<div class="layout">
  <cc-sidebar></cc-sidebar>

  <div>
    <header class="appbar">
      <div class="left">
        <div class="logo">◆</div>
        <div class="brand">Seu Condomínio</div>
      </div>
      <div class="actions">
        <button id="btnInstall" class="btn install" title="Instalar WebApp">Instalar</button>
        <button id="btnLogout" class="btn ghost">Sair</button>
      </div>
    </header>

    <main id="view" aria-live="polite">Carregando…</main>
  </div>
</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";
  import "./cc-sidebar.js";
  import { navigate, initRouter } from "./router.js";

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) { location.href = "app/login.html"; }

  document.getElementById("btnLogout").onclick = async ()=>{
    await supabase.auth.signOut(); location.href = "app/login.html";
  };

  // PWA install
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; });
  document.getElementById('btnInstall').onclick = async ()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
  };

  initRouter({
    routes: {
      "/":               { html: "app/views/dashboard.html" },
      "/aprovacoes":     { html: "app/views/admin-requests.html", js: "app/views/admin-requests.js",
                           roles: ["GESTOR_TENANTS","MASTER","ADMIN_TENANT","MANAGER_CONDO"] }
    },
    fallback: "/",
    target: document.getElementById("view")
  });

  window.addEventListener("cc:navigate", (e)=> navigate(e.detail.path));
</script>
</body>
</html>
