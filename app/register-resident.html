<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Condo • Cadastro de Inquilino</title>
<style>
  :root{ --brand-start:#6C2BD9; --brand-end:#8B5CF6; --on-brand:#fff;
         --bg:#0B0F16; --text:#E8ECF4; --muted:#A3ADC2; --field:#12182A; --border:#233048; --radius:16px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);background:linear-gradient(160deg,#0b0f16,#0d1020);display:grid;place-items:center;padding:24px}
  .wrap{width:min(720px,100%);display:grid;gap:16px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;display:grid;gap:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:720px){.row{grid-template-columns:1fr}}
  .field{background:var(--field);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .field input{width:100%;border:none;outline:none;background:transparent;color:var(--text)}
  .btn{border:none;border-radius:12px;padding:14px 16px;font-weight:800;
       background:linear-gradient(90deg,var(--brand-start),var(--brand-end));color:var(--on-brand);cursor:pointer}
  .ok{color:#22c55e;font-size:13px;min-height:18px}.err{color:#ef4444;font-size:13px;min-height:18px}
  .muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0">Cadastro • Inquilino (Usuário)</h2>
  <p class="muted">Seu pedido será avaliado pelo Administrador/Síndico do condomínio.</p>

  <form id="form" class="card">
    <div class="row">
      <div class="field"><input name="tenant" placeholder="Administradora (nome ou ID)"/></div>
      <div class="field"><input name="condo" placeholder="Condomínio (nome ou ID)"/></div>
    </div>
    <div class="field"><input name="unit" placeholder="Unidade (ex.: Bloco A, Apto 101)"/></div>
    <div class="row">
      <div class="field"><input name="email" type="email" required placeholder="E-mail"/></div>
      <div class="field"><input name="password" type="password" required placeholder="Senha"/></div>
    </div>
    <button class="btn" type="submit">Enviar para aprovação</button>
    <div class="ok" id="ok"></div><div class="err" id="err"></div>
    <div class="muted"><a href="register-select.html" style="color:#b3b8ff">Voltar</a></div>
  </form>
</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";
  const pre = new URLSearchParams(location.search).get("email");
  if (pre) document.querySelector('input[name="email"]').value = pre;

  async function signUpAndRequest(email, password, payload){
    const { data, error } = await supabase.auth.signUp({
      email, password, options:{ emailRedirectTo: location.origin + "/app/index.html" }
    });
    if (error) throw new Error(error.message);
    const { error: rErr } = await supabase.from('registration_requests')
      .insert([{ email, role_requested:'INQUILINO', payload }]);
    if (rErr) throw new Error(rErr.message);
  }

  const form = document.getElementById('form'), ok=document.getElementById('ok'), err=document.getElementById('err');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); ok.textContent=""; err.textContent="";
    const o = Object.fromEntries(new FormData(form).entries());
    try{
      await signUpAndRequest(o.email, o.password, { tenant:o.tenant, condo:o.condo, unit:o.unit });
      ok.textContent="Solicitação registrada! Verifique seu e-mail e aguarde aprovação.";
      form.reset();
    }catch(ex){ err.textContent = ex.message; }
  });
</script>
</body>
</html>
