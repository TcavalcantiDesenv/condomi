<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!-- CSP (dev): libera Supabase, esm.sh e localhost/127.0.0.1 (http/ws) -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co wss://*.supabase.in https://esm.sh http://127.0.0.1:* ws://127.0.0.1:* http://localhost:* ws://localhost:*; script-src 'self' 'unsafe-inline' https://esm.sh; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; frame-src 'self'; base-uri 'self'; form-action 'self'; worker-src 'self' blob:;">

<title>Condo • Acesso</title>
<link rel="icon" href="/favicon.svg"/>

<style>
  :root{
    --brand-start:#6C2BD9; --brand-end:#8B5CF6; --on-brand:#fff;
    --bg:#0A0E14; --panel:#0F1420; --text:#E8ECF4; --muted:#A3ADC2;
    --field:#12182A; --border:#233048; --radius:14px; --gap:14px;
    --accent:#7C3AED; --danger:#EF4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 600px at 70% 30%, #2a2f70 0%, transparent 60%),
      radial-gradient(800px 400px at 80% 70%, #6b21a8 0%, transparent 60%),
      linear-gradient(135deg, #0b1020, #0a0e14);
    display:grid; place-items:center; padding:24px;
  }
  .card{
    width:min(1100px,100%); min-height:560px; display:grid; grid-template-columns: 420px 1fr;
    background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.08); border-radius:24px; overflow:hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
  }
  @media (max-width: 900px){ .card{ grid-template-columns:1fr; } }

  .left{
    background:linear-gradient(160deg, var(--panel), rgba(20,24,36,.6));
    padding:36px 28px; display:flex; flex-direction:column; gap:var(--gap);
  }
  .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.4px; }
  .brand .logo{
    width:34px; height:34px; border-radius:50%;
    background:linear-gradient(135deg, var(--brand-start), var(--brand-end));
    display:grid; place-items:center; color:#fff; font-weight:900;
  }
  .welcome{ margin-top:18px; font-size:clamp(28px, 4vw, 44px); line-height:1.05; font-weight:800;}
  form{ margin-top:6px; display:flex; flex-direction:column; gap:12px; }
  .field{
    background:var(--field); border:1px solid var(--border); border-radius:999px; padding:12px 16px;
    display:flex; gap:10px; align-items:center;
  }
  .field input{
    background:transparent; border:none; outline:none; color:var(--text); width:100%; font-size:15px;
  }
  .btn{
    border:none; cursor:pointer; border-radius:999px; padding:12px 18px; font-weight:700;
    background:linear-gradient(90deg, var(--brand-start), var(--brand-end)); color:var(--on-brand);
    transition:.2s transform ease, .2s filter ease;
  }
  .btn:active{ transform:translateY(1px) }
  .muted{ color:var(--muted); font-size:13px; }
  .error{ color:var(--danger); font-size:13px; min-height:18px; }
  .right{
    position:relative; padding:28px; overflow:hidden;
    background:
      radial-gradient(1000px 500px at 30% 20%, rgba(124,58,237,.35), transparent 60%),
      radial-gradient(1000px 600px at 60% 80%, rgba(99,102,241,.35), transparent 60%),
      linear-gradient(160deg, rgba(14,18,30,.6), rgba(10,12,20,.6));
  }
  .wave{
    position:absolute; inset:auto -10% -15% -10%; height:70%;
    background:linear-gradient(90deg,#1e40af,#3b82f6,#8b5cf6,#ec4899);
    opacity:.35; filter:blur(30px); border-radius:50% 50% 0 0 / 25% 25% 0 0;
    transform:skewY(-8deg);
  }
  nav.top{
    position:absolute; top:10px; right:16px; display:flex; gap:26px; font-size:14px; color:#DDE3F7; opacity:.9;
  }
  nav.top a{ color:inherit; text-decoration:none }
  .right h1{
    position:absolute; left:40px; bottom:48px; font-size:clamp(34px,6vw,64px); line-height:1.02; margin:0;
  }
</style>
</head>
<body>
<div class="card" role="main">
  <section class="left" aria-label="Área de login">
    <div class="brand" aria-label="Marca">
      <div class="logo">◆</div><span>Seu Condomínio</span>
    </div>

    <div class="welcome">Bem-vindo de volta.</div>

    <form id="loginForm" novalidate>
      <div class="field"><input id="email" name="email" type="email" autocomplete="username" required placeholder="E-mail"/></div>
      <div class="field"><input id="password" name="password" type="password" autocomplete="current-password" required placeholder="Senha"/></div>
      <button class="btn" type="submit" id="btnLogin" aria-label="Entrar">Entrar</button>
      <label class="muted"><input id="remember" type="checkbox" checked/> Manter conectado</label>
      <div id="msg" class="error" role="status" aria-live="polite"></div>
      <div class="muted">Novo por aqui? <a href="register-select.html" style="color:#b3b8ff" rel="noopener">Crie sua conta</a></div>
    </form>
  </section>

  <section class="right" aria-hidden="true">
    <nav class="top">
      <a href="#" rel="noopener">Home</a>
      <a href="#" rel="noopener">Download</a>
      <a href="#" rel="noopener">Sobre</a>
      <a href="register-select.html" rel="noopener">Registrar</a>
    </nav>
    <div class="wave"></div>
    <h1>Welcome<br/>Back.</h1>
  </section>
</div>

<script type="module">
  import { supabase, fetchEffectiveRoles } from "./supabaseClient.js";

  const $ = (sel)=>document.querySelector(sel);
  const form = $("#loginForm"), msg=$("#msg"), btn=$("#btnLogin");

  form.addEventListener("submit", async (e)=>{
    e.preventDefault(); msg.textContent=""; btn.disabled=true;

    const email = $("#email").value.trim();
    const password = $("#password").value;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error){
      msg.textContent = "Não foi possível entrar. Redirecionando para cadastro…";
      setTimeout(()=> location.href = `register-select.html?email=${encodeURIComponent(email)}`, 900);
      btn.disabled=false;
      return;
    }

    // Sessão ok → buscar papéis efetivos
    const roles = await fetchEffectiveRoles();

    // Roteamento inicial por papel
    if (roles.includes("MASTER") || roles.includes("ADMIN_TENANT") || roles.includes("MANAGER_CONDO") || roles.includes("RESIDENT")){
      location.href = "app/index.html";
      return;
    }

    // Fallback
    location.href = "app/index.html";
  });
</script>
</body>
</html>
