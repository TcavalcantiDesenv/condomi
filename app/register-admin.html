<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Condo • Cadastro de Administradora</title>
<style>
  :root{ --brand-start:#6C2BD9; --brand-end:#8B5CF6; --on-brand:#fff;
         --bg:#0B0F16; --panel:#0F1420; --text:#E8ECF4; --muted:#A3ADC2;
         --field:#12182A; --border:#233048; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);background:linear-gradient(160deg,#0b0f16,#0d1020);display:grid;place-items:center;padding:24px}
  .wrap{width:min(720px,100%);display:grid;gap:16px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:900;
        background:linear-gradient(135deg,var(--brand-start),var(--brand-end))}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
        border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:18px;display:grid;gap:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:720px){.row{grid-template-columns:1fr}}
  .field{background:var(--field);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .field input,.field textarea{width:100%;border:none;outline:none;background:transparent;color:var(--text);font-size:14px}
  .btn{border:none;border-radius:12px;padding:14px 16px;font-weight:800;cursor:pointer;
       background:linear-gradient(90deg,var(--brand-start),var(--brand-end));color:var(--on-brand)}
  .muted{color:var(--muted);font-size:13px}
  .ok{color:#22c55e;font-size:13px;min-height:18px}.err{color:#ef4444;font-size:13px;min-height:18px}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand"><div class="logo">◆</div><h2 style="margin:0">Cadastro • Administradora (Master)</h2></div>
  <p class="muted">Seu pedido será aprovado apenas pelo <b>Gestor de Administradoras</b>.</p>

  <form id="form" class="card">
    <div class="row">
      <div class="field"><input name="company" required placeholder="Razão social da administradora"/></div>
      <div class="field"><input name="cnpj" placeholder="CNPJ (opcional)"/></div>
    </div>
    <div class="row">
      <div class="field"><input name="email" type="email" required placeholder="E-mail"/></div>
      <div class="field"><input name="password" type="password" required placeholder="Senha"/></div>
    </div>
    <div class="field"><textarea name="notes" rows="3" placeholder="Observações (opcional)"></textarea></div>
    <button class="btn" type="submit">Solicitar aprovação</button>
    <div class="ok" id="ok"></div><div class="err" id="err"></div>
    <div class="muted">Precisa de outro tipo? <a href="register-select.html" style="color:#b3b8ff">Voltar</a></div>
  </form>
</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";

  // Pré-preenche e-mail, se veio como querystring
  const pre = new URLSearchParams(location.search).get("email");
  if (pre) document.querySelector('input[name="email"]').value = pre;

  async function signUpAndRequest(email, password, payload){
    const { data: sData, error: sErr } = await supabase.auth.signUp({
      email, password, options:{ emailRedirectTo: location.origin + "/app/index.html" }
    });
    if (sErr) throw new Error(sErr.message);
    const { error: rErr } = await supabase.from('registration_requests')
      .insert([{ email, role_requested:'ADMINISTRADORA', payload }]);
    if (rErr) throw new Error(rErr.message);
    return sData;
  }

  const form = document.getElementById('form');
  const ok = document.getElementById('ok');
  const err = document.getElementById('err');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); ok.textContent=""; err.textContent="";
    const fd = new FormData(form); const o = Object.fromEntries(fd.entries());
    try{
      await signUpAndRequest(o.email, o.password, {company:o.company, cnpj:o.cnpj, notes:o.notes});
      ok.textContent = "Solicitação registrada! Verifique seu e-mail e aguarde aprovação.";
      form.reset();
    }catch(ex){ err.textContent = ex.message; }
  });
</script>
</body>
</html>
